<!DOCTYPE html>
<html>
  <head>
    <title>ChatBot</title>
    <style>
        body{
            font-family: Arial, Helvetica, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }
        .send-button:enabled{
            background-color: rgb(0, 123, 255);
            color: white;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            margin-left: 10px;
            border-radius: 10px;
            font-size: 15px;
        }
        .send-button:disabled {
            opacity: 0.5;
            background-color: rgb(4, 0, 255);
            color: #dfd5e6;
            cursor: not-allowed;
            padding: 12px 20px;
            margin-left: 10px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
        }
        .chat-input{
            padding: 12px 15px;
            border-radius: 10px;
            border: 2px solid #ccc;
            font-size: 15px;
            flex-grow: 1;
        }
        .chat-input-container{
            display: flex;
            padding: 20px;
            background-color: white;
            border-top: 1px solid #e0e0e0;
            position: sticky;
            bottom: 0;
        }
        .app-container{
           max-width: 600px;
           margin-left: auto;
           margin-right: auto;
           height: 100vh;
           display: flex;
           flex-direction: column;
        }
        .chat-message-container{
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            scrollbar-width: none;
        }
        .chat-message-container::-webkit-scrollbar {
            display: none;
        }
        .chat-message-user{
            justify-content: end;
            display: flex;
            align-items: start;
        }
        .chat-message-robot{
            justify-content: start;
            display: flex;
            align-items: start;
        }
        .chat-message-text{
            background-color: rgb(237, 237, 237);
            font-family: Arial, Helvetica, sans-serif;
            padding: 15px 20px;
            border-radius: 10px;
            margin-right: 10px;
            margin-left: 10px;
            margin-bottom: 20px;
            max-width: 300px;
        }
        .chat-message-profile{
            width: 45px;
            height: 45px;
            flex-shrink: 0;
        }
    </style>
  </head>
  <body>
    <div class="js-container"></div>
    <script src="https://unpkg.com/supersimpledev/dayjs.js"></script>
    
    <script src="https://unpkg.com/supersimpledev/react.js"></script>
    <script src="https://unpkg.com/supersimpledev/react-dom.js"></script>

    <script src="https://unpkg.com/supersimpledev/chatbot.js"></script>

    <script src="https://unpkg.com/supersimpledev/babel.js"></script>
    <script type="text/babel">

      function ChatInput({chatMessages, setChatMessages}){
        const [inputText, setInputText] = React.useState('');
        const [isLoading, setIsLoading] = React.useState(false);

        function saveInputText(event){
            setInputText(event.target.value);
        }

        async function SendMessage(){
            
            if(!inputText.trim() || isLoading){
                return;
            }

            setIsLoading(true);
            const messageToSend = inputText;
            setInputText('');

            const newChatMessages =[
              ...chatMessages,
              {
                  message: messageToSend,
                  sender: 'user',
                  id: crypto.randomUUID()
              }
            ]

            setChatMessages([
                ...newChatMessages,
                {
                    message: 'Loading ...',
                    sender:'robot',
                    id: crypto.randomUUID()
                }
            ]
            );

            const response = await Chatbot.getResponseAsync(messageToSend);
            setChatMessages([
                ...newChatMessages,
                {
                  message: response,
                  sender: 'robot',
                  id: crypto.randomUUID()
                }
            ]);
            setIsLoading(false);
        }
        function handleKeyDown(event){
            if(event.key === 'Enter'){
                SendMessage();
            }
            else if(event.key === 'Escape'){
                setInputText('');
            }
        }

        return (
          <div className = "chat-input-container">
          <input className = "chat-input" placeholder ={isLoading ? "Waiting for the response ..." :"Send a message to the ChatBot"} onChange ={saveInputText}
          value = {inputText} onKeyDown = {handleKeyDown} disabled={isLoading} 
          ></input>
          <button className = "send-button" onClick = {SendMessage} disabled = {!inputText.trim() || isLoading}>
            {isLoading ? 'Sending ...' : 'Send'}
          </button>
          </div>
        );
      }
      
      function ChatMessage(props){
        const {message, sender} = props;

        return(
          <div className = {sender === 'user' ? 'chat-message-user' : 'chat-message-robot'}>
            {sender === "robot" && <img src="Robot.png" className="chat-message-profile" alt="Robot" />}
            <div className = "chat-message-text">
                {message}
            </div>
            {sender === "user" && <img src="Human.png" className="chat-message-profile" alt="Human" />}
          </div>
        );
      }

      function ChatMessages({chatMessages}){
        const chatMessagesRef = React.useRef(null);

        React.useEffect(() => {
            const containerElem = chatMessagesRef.current;
            if(containerElem){
                containerElem.scrollTop = containerElem.scrollHeight;
            }
        },[chatMessages]);

        return(
          <div className = "chat-message-container" ref={chatMessagesRef}>
          {
              chatMessages.map((chatMessage) => 
              {
                return(
                  <ChatMessage
                  message = {chatMessage.message} 
                  sender = {chatMessage.sender}
                  key = {chatMessage.id}
                  />
                )
              })
            }
          </div>
        )
      }

      function App(){

        const [chatMessages, setChatMessages] = React.useState([{
          message: 'Hello ChatBot',
          sender: 'user',
          id: 'id1'
        },{
          message: 'Hey! How can I help you?',
          sender: 'robot',
          id: 'id2'
        },{
          message: 'Can you get me todays date',
          sender: 'user',
          id: 'id3'
        },{
          message: `Today is ${dayjs().format('MMMM D, YYYY')}`,
          sender: 'robot',
          id: 'id4'
        }]);

        return (
          <div className = "app-container">
            <ChatMessages 
                chatMessages = {chatMessages}
            />
            <ChatInput 
                chatMessages = {chatMessages}
                setChatMessages = {setChatMessages}
            />
          </div>
        )
      }

      const container = document.querySelector('.js-container');
      const root = ReactDOM.createRoot(container);
      root.render(<App />);
    </script>
  </body>
</html>