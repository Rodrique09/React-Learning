<!DOCTYPE html>
<html>
  <head>
    <title>ChatBot</title>
  </head>
  <body>
    <div class="js-container"></div>
    <script src="https://unpkg.com/supersimpledev/dayjs.js"></script>
    
    <script src="https://unpkg.com/supersimpledev/react.js"></script>
    <script src="https://unpkg.com/supersimpledev/react-dom.js"></script>

    <script src="https://unpkg.com/supersimpledev/chatbot.js"></script>

    <script src="https://unpkg.com/supersimpledev/babel.js"></script>
    <script type="text/babel">

      function ChatInput({chatMessages, setChatMessages}){
        const [inputText, setInputText] = React.useState('');
        const [isLoading, setIsLoading] = React.useState(false);

        function saveInputText(event){
            setInputText(event.target.value);
        }

        async function SendMessage(){
            
            if(!inputText.trim() || isLoading){
                return;
            }

            setIsLoading(true);
            setInputText('');

            const newChatMessages =[
              ...chatMessages,
              {
                  message: inputText,
                  sender: 'user',
                  id: crypto.randomUUID()
              }
            ]

            setChatMessages([
                ...newChatMessages,
                {
                    message: 'Loading ...',
                    sender:'robot',
                    id: crypto.randomUUID()
                }
            ]
            );

            const response = await Chatbot.getResponseAsync(inputText);
            setChatMessages([
                ...newChatMessages,
                {
                  message: response,
                  sender: 'robot',
                  id: crypto.randomUUID()
                }
            ]);
            setIsLoading(false);
        }
        function handleKeyDown(event){
            if(event.key === 'Enter'){
                SendMessage();
            }
            else if(event.key === 'Escape'){
                setInputText('');
            }
        }

        return (
          <>
          <input placeholder ={isLoading ? "Waiting for the response ..." :"Send a message to the ChatBot"} size ="40" onChange ={saveInputText}
          value = {inputText} onKeyDown = {handleKeyDown} disabled={isLoading}
          ></input>
          <button onClick = {SendMessage} disabled = {!inputText.trim() || isLoading}>
            {isLoading ? 'Sending ...' : 'Send'}
          </button>
          </>
        );
      }
      
      function ChatMessage(props){
        const {message, sender} = props;

        return(
          <div>
            {sender === "robot" && <img src="Robot.png" width ="50" alt="Robot" />}
            {message}
            {sender === "user" && <img src="Human.png" width ="50" alt="Human" />}
          </div>
        );
      }

      function ChatMessages({chatMessages}){
        //chatMessages is an array of objects
        //setChatMessages is a function that updates the chatMessages array
        return(
          <>
          {
              chatMessages.map((chatMessage) => 
              {
                return(
                  <ChatMessage
                  message = {chatMessage.message} 
                  sender = {chatMessage.sender}
                  key = {chatMessage.id}
                  />
                )
              })
            }
          </>
        )
      }

      function App(){

        const [chatMessages, setChatMessages] = React.useState([{
          message: 'Hello ChatBot',
          sender: 'user',
          id: 'id1'
        },{
          message: 'Hey! How can I help you?',
          sender: 'robot',
          id: 'id2'
        },{
          message: 'Can you get me todays date',
          sender: 'user',
          id: 'id3'
        },{
          message: `Today is ${dayjs().format('MMMM D, YYYY')}`,
          sender: 'robot',
          id: 'id4'
        }]);

        return (
          <>
            <ChatInput 
                chatMessages = {chatMessages}
                setChatMessages = {setChatMessages}
            />
            <ChatMessages 
                chatMessages = {chatMessages}
            />
          </>
        )
      }

      const container = document.querySelector('.js-container');
      const root = ReactDOM.createRoot(container);
      root.render(<App />);
    </script>
  </body>
</html>